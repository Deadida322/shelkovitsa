#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ nginx

echo "üîÑ –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å nginx..."

# 1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º nginx
echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ nginx..."
sudo systemctl stop nginx

# 2. –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
sudo rm -f /etc/nginx/nginx.conf

# 3. –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
sudo cp /etc/nginx/nginx.conf.backup /etc/nginx/nginx.conf 2>/dev/null || echo "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

# 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º HTTP-only –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ HTTP-only –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
sudo cp ../deploy/nginx-http-only.conf /etc/nginx/nginx.conf

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if sudo nginx -t; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
    
    # 6. –ó–∞–ø—É—Å–∫–∞–µ–º nginx
    echo "üöÄ –ó–∞–ø—É—Å–∫ nginx..."
    sudo systemctl start nginx
    sudo systemctl enable nginx
    
    # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
    echo "üìä –°—Ç–∞—Ç—É—Å nginx:"
    sudo systemctl status nginx --no-pager
    
    echo ""
    echo "‚úÖ Nginx —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
    echo "üåê –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ HTTP (–ø–æ—Ä—Ç 80)"
    echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤:"
    sudo netstat -tlnp | grep :80
    
else
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx"
    echo "üìã –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:"
    sudo nginx -t
    exit 1
fi
