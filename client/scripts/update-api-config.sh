#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ API

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ API..."

# 1. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
echo "üî® –®–∞–≥ 1: –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
./scripts/build-ssr.sh
if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
    exit 1
fi

# 2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
echo "‚èπÔ∏è  –®–∞–≥ 2: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Nuxt.js —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl stop nuxt-app

# 3. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üì¶ –®–∞–≥ 3: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
sudo cp -r .output/* /var/www/shelkovitsa/client/

# 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞
echo "üîß –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞..."
sudo cp ../deploy/nuxt-app.service /etc/systemd/system/nuxt-app.service
sudo systemctl daemon-reload

# 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
echo "üîí –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
sudo chown -R www-data:www-data /var/www/shelkovitsa/client
sudo chmod -R 755 /var/www/shelkovitsa/client

# 6. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
echo "üöÄ –®–∞–≥ 6: –ó–∞–ø—É—Å–∫ Nuxt.js —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl start nuxt-app
sudo systemctl enable nuxt-app

# 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo "üìä –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞..."
sudo systemctl status nuxt-app --no-pager

# 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üîç –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
echo "–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
sudo systemctl show nuxt-app | grep Environment

# 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
echo "üîç –®–∞–≥ 9: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤..."
sudo netstat -tlnp | grep -E ':(8000|3000|80|443)'

# 10. –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
echo "üåê –®–∞–≥ 10: –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏..."
if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 | grep -q "200"; then
    echo "‚úÖ Nuxt.js –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000"
else
    echo "‚ùå Nuxt.js –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000"
fi

echo ""
echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ API –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: sudo systemctl status nuxt-app"
echo "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: sudo journalctl -u nuxt-app -f"
echo "üåê –¢–µ—Å—Ç: curl http://localhost:3000"
